name: Build and Push Docker Images

on:
  push:
    tags:
      - 'v*.*.*'
  repository_dispatch:
    types: [docker-build]
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms (comma separated)'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: string

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_IMAGE: elchi-coredns
  COREDNS_VERSION: v1.11.1

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      platforms: ${{ steps.get_platforms.outputs.platforms }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION=$(cat VERSION)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Get platforms
        id: get_platforms
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PLATFORMS="${{ github.event.inputs.platforms }}"
          else
            PLATFORMS="linux/amd64,linux/arm64"
          fi
          echo "platforms=${PLATFORMS}" >> $GITHUB_OUTPUT
          echo "Building for platforms: ${PLATFORMS}"

  build-amd64:
    runs-on: ubuntu-22.04
    needs: prepare
    if: contains(needs.prepare.outputs.platforms, 'linux/amd64')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push AMD64 image
        env:
          DOCKER_BUILDKIT: 1
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_NAME="${DOCKER_USERNAME}/${DOCKER_IMAGE}"
          IMAGE_TAG="${IMAGE_NAME}:v${VERSION}-amd64"

          # Build AMD64 platform
          docker buildx build \
            --no-cache \
            --platform linux/amd64 \
            --build-arg "COREDNS_VERSION=${COREDNS_VERSION}" \
            --build-arg "TARGETARCH=amd64" \
            -t "${IMAGE_TAG}" \
            -f Dockerfile \
            --push \
            .

          echo "‚úÖ AMD64 image built and pushed: ${IMAGE_TAG}"

  build-arm64:
    runs-on: ubuntu-22.04
    needs: prepare
    if: contains(needs.prepare.outputs.platforms, 'linux/arm64')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push ARM64 image
        env:
          DOCKER_BUILDKIT: 1
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_NAME="${DOCKER_USERNAME}/${DOCKER_IMAGE}"
          IMAGE_TAG="${IMAGE_NAME}:v${VERSION}-arm64"

          # Build ARM64 platform
          docker buildx build \
            --no-cache \
            --platform linux/arm64 \
            --build-arg "COREDNS_VERSION=${COREDNS_VERSION}" \
            --build-arg "TARGETARCH=arm64" \
            -t "${IMAGE_TAG}" \
            -f Dockerfile \
            --push \
            .

          echo "‚úÖ ARM64 image built and pushed: ${IMAGE_TAG}"

  create-manifest:
    runs-on: ubuntu-22.04
    needs: [prepare, build-amd64, build-arm64]
    if: contains(needs.prepare.outputs.platforms, ',')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Create multi-platform manifest
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_NAME="${DOCKER_USERNAME}/${DOCKER_IMAGE}"
          MANIFEST_TAG="${IMAGE_NAME}:v${VERSION}"
          LATEST_TAG="${IMAGE_NAME}:latest"

          # Create manifest list from platform-specific images
          docker manifest create "${MANIFEST_TAG}" \
            "${IMAGE_NAME}:v${VERSION}-amd64" \
            "${IMAGE_NAME}:v${VERSION}-arm64"

          # Push versioned manifest
          docker manifest push "${MANIFEST_TAG}"

          # Create and push latest manifest
          docker manifest create "${LATEST_TAG}" \
            "${IMAGE_NAME}:v${VERSION}-amd64" \
            "${IMAGE_NAME}:v${VERSION}-arm64"

          docker manifest push "${LATEST_TAG}"

          echo "‚úÖ Multi-platform manifest created: ${MANIFEST_TAG}"
          echo "‚úÖ Latest tag updated: ${LATEST_TAG}"

          # Output image details
          echo ""
          echo "üì¶ Docker Images Published:"
          echo "  - ${MANIFEST_TAG}"
          echo "  - ${LATEST_TAG}"
          echo ""
          echo "üîç Pull command:"
          echo "  docker pull ${MANIFEST_TAG}"
          echo "  docker pull ${LATEST_TAG}"
